import dotenv from "dotenv";
import express from "express";
import TelegramBot from "node-telegram-bot-api";
import { initDB } from "./lib/db.js";
import { startGame, handleClaim, handleVoucher } from "./lib/game.js";

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

const bot = new TelegramBot(process.env.BOT_TOKEN, { polling: true });

// --- Game logic ---
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  await initDB();
  bot.sendMessage(chatId, "ðŸš€ Welcome to Cosmic Foundry Quest!\n\nEarn rewards by exploring the galaxy.\n\nUse /claim to get daily points or /play to start your mission!");
});

bot.onText(/\/play/, async (msg) => {
  const chatId = msg.chat.id;
  await startGame(bot, chatId);
});

bot.onText(/\/claim/, async (msg) => {
  const chatId = msg.chat.id;
  await handleClaim(bot, chatId);
});

bot.onText(/\/voucher/, async (msg) => {
  const chatId = msg.chat.id;
  await handleVoucher(bot, chatId);
});

// --- Webhook setup for Railway / Vercel ---
app.get("/", (req, res) => {
  res.send("âœ… Cosmic Foundry Bot is running smoothly!");
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
